<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>결제 완료 - 라잇</title>
  <link rel="stylesheet" href="service.css">

  <!-- 파비콘 -->
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
  <meta name="theme-color" content="#ffffff">

  <style>
    .pc-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .pc-card {
      background: #fff;
      border-radius: 24px;
      padding: 48px 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    }

    .pc-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 36px;
    }

    .pc-icon-processing {
      background: #EFF6FF;
    }

    .pc-icon-success {
      background: #F0FFF5;
    }

    .pc-icon-fail {
      background: #FFEDED;
    }

    .pc-title {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 12px;
    }

    .pc-desc {
      font-size: 15px;
      color: #6B7280;
      line-height: 1.6;
      margin: 0 0 32px;
    }

    .pc-btn {
      display: inline-block;
      padding: 14px 32px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }

    .pc-btn:hover {
      opacity: 0.85;
    }

    .pc-btn-primary {
      background: #2563EB;
      color: #fff;
    }

    .pc-btn-secondary {
      background: #F3F4F6;
      color: #374151;
      margin-top: 12px;
    }

    .pc-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E5E7EB;
      border-top-color: #2563EB;
      border-radius: 50%;
      animation: pc-spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes pc-spin {
      to {
        transform: rotate(360deg);
      }
    }

    .pc-email-info {
      background: #EFF6FF;
      border-radius: 12px;
      padding: 16px;
      margin: 0 0 24px;
      font-size: 14px;
      color: #1D4ED8;
    }

    .pc-hidden {
      display: none;
    }
  </style>
</head>

<body style="background: #F9FAFB; margin: 0;">
  <div class="pc-container">
    <!-- Processing -->
    <div class="pc-card" id="sectionProcessing">
      <div class="pc-spinner"></div>
      <h1 class="pc-title">결제 확인 중</h1>
      <p class="pc-desc">결제를 확인하고 있습니다.<br>잠시만 기다려주세요.</p>
    </div>

    <!-- Success -->
    <div class="pc-card pc-hidden" id="sectionSuccess">
      <div class="pc-icon pc-icon-success">&#10003;</div>
      <h1 class="pc-title">결제가 완료되었습니다!</h1>
      <div class="pc-email-info" id="emailInfo"></div>
      <p class="pc-desc">
        입력하신 이메일로 다운로드 링크가 전송됩니다.<br>
        아래 버튼으로 바로 다운로드할 수도 있습니다.
      </p>
      <a id="downloadBtn" href="#" class="pc-btn pc-btn-primary pc-hidden" download>다운로드</a>
      <a href="service.html" class="pc-btn pc-btn-secondary" style="display: block;">서비스 페이지로 돌아가기</a>
    </div>

    <!-- Failure -->
    <div class="pc-card pc-hidden" id="sectionFail">
      <div class="pc-icon pc-icon-fail">&#10007;</div>
      <h1 class="pc-title">결제에 실패했습니다</h1>
      <p class="pc-desc" id="failMessage">오류가 발생했습니다. 다시 시도해 주세요.</p>
      <a href="service.html" class="pc-btn pc-btn-primary">다시 시도하기</a>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Supabase 환경 설정 (script.js와 동일)
    const SUPABASE_CONFIG = {
      prod: {
        url: 'https://ywaldpxprcusqmfdnlfk.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3YWxkcHhwcmN1c3FtZmRubGZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTQ1NDIsImV4cCI6MjA4MTM5MDU0Mn0.mGrw1aI-Uc1CZT__AEDuQLX1LqBvTc4GJHF58r74MYY'
      },
      dev: {
        url: 'https://xianrhwkdarupnvaumti.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpYW5yaHdrZGFydXBudmF1bXRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDM1MzEsImV4cCI6MjA3NjgxOTUzMX0.0elH2T_0kz5FVQnGEfOEfp6HFbwGvYoZZsAlns4PNyo'
      }
    };

    const hostname = window.location.hostname;
    const env = (hostname === 'lyt-app.io' || hostname === 'www.lyt-app.io') ? 'prod' : 'dev';
    const SUPABASE_URL = SUPABASE_CONFIG[env].url;
    const SUPABASE_ANON_KEY = SUPABASE_CONFIG[env].anonKey;

    function showSection(id) {
      document.getElementById('sectionProcessing').classList.add('pc-hidden');
      document.getElementById('sectionSuccess').classList.add('pc-hidden');
      document.getElementById('sectionFail').classList.add('pc-hidden');
      document.getElementById(id).classList.remove('pc-hidden');
    }

    function showSuccess(guestEmail, downloadToken, productId) {
      if (guestEmail) {
        document.getElementById('emailInfo').textContent = guestEmail + ' 으로 다운로드 링크가 전송됩니다.';
      } else {
        document.getElementById('emailInfo').style.display = 'none';
      }

      // 즉시 다운로드 버튼 표시
      if (downloadToken) {
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.href = `${SUPABASE_URL}/functions/v1/download-digital-product?token=${downloadToken}`;
        downloadBtn.classList.remove('pc-hidden');
        downloadBtn.style.display = 'inline-block';
      }

      // localStorage에 구매 정보 저장
      if (downloadToken && productId) {
        savePurchaseToStorage(productId, downloadToken);
      }

      showSection('sectionSuccess');
    }

    function savePurchaseToStorage(productId, downloadToken) {
      try {
        const storageKey = 'lyt_purchases';
        const existing = JSON.parse(localStorage.getItem(storageKey) || '{}');
        existing[productId] = {
          downloadToken: downloadToken,
          purchasedAt: new Date().toISOString(),
        };
        localStorage.setItem(storageKey, JSON.stringify(existing));
      } catch (e) {
        console.warn('Failed to save purchase to localStorage:', e);
      }
    }

    function showFail(message) {
      document.getElementById('failMessage').textContent = message || '오류가 발생했습니다. 다시 시도해 주세요.';
      showSection('sectionFail');
    }

    (async function () {
      const params = new URLSearchParams(window.location.search);

      // TossPayments 실패 콜백
      if (params.get('code') || params.get('status') === 'fail') {
        showFail(params.get('message') || '결제가 취소되었거나 실패했습니다.');
        return;
      }

      const paymentKey = params.get('paymentKey');
      const orderId = params.get('orderId');
      const amount = Number(params.get('amount'));
      const guestEmail = params.get('guestEmail');

      if (!paymentKey || !orderId || !amount) {
        showFail('결제 정보가 올바르지 않습니다.');
        return;
      }

      try {
        // confirm-payment Edge Function 호출 (raw fetch로 Authorization 헤더 없이)
        const response = await fetch(`${SUPABASE_URL}/functions/v1/confirm-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            paymentKey: paymentKey,
            orderId: orderId,
            amount: amount,
            idempotencyKey: paymentKey,
          }),
        });

        const data = await response.json();

        if (data.success) {
          showSuccess(guestEmail, data.downloadToken, data.productId);
        } else {
          showFail(data.message || '결제 확인에 실패했습니다.');
        }
      } catch (err) {
        console.error('결제 확인 오류:', err);
        showFail('결제 확인 중 오류가 발생했습니다. 고객센터에 문의해 주세요.');
      }
    })();
  </script>
</body>

</html>
